#!/usr/bin/python3
# SPDX-FileCopyrightText: 2025 Kaito Yagiuchi
# SPDX-License-Identifier: BSD-3-Clause


import sys
sys.dont_write_bytecode = True
from keys import keys, get_key
import os


def vigenere_encrypt(plaintext, key):
    key = key.lower()
    ciphertext = ""
    key_index = 0
    for char in plaintext:
        if char.isalpha(): 
            shift = ord(key[key_index % len(key)]) - ord('a') 
            base = ord('A') if char.isupper() else ord('a') 
            ciphertext += chr((ord(char) - base + shift) % 26 + base) 
            key_index += 1 
        else: 
            ciphertext += char 
    return ciphertext

def vigenere_decrypt(ciphertext, key):
    key = key.lower()
    plaintext = ""
    key_index = 0
    for char in ciphertext:
        if char.isalpha():
            shift = ord(key[key_index % len(key)]) - ord('a')
            base = ord('A') if char.isupper() else ord('a')
            plaintext += chr((ord(char) - base - shift) % 26 + base)
            key_index += 1
        else:
            plaintext += char
    return plaintext

def read_alpha_input(prompt=None, is_tty=False):
    try:
        if is_tty and prompt:
            raw = input(prompt)
        else:
            raw = input()
    except EOFError:
        sys.exit(2)
    except Exception:
        sys.exit(1)

    line = raw.strip()

    if not line:
        sys.exit(2)
    if not line.isascii():
        sys.exit(3)
    if not all(c.isalpha() or c == ' ' for c in line):
        sys.exit(4)
    return line

if __name__ == "__main__":
    is_tty = sys.stdin.isatty()
    try:
        raw = input("モード (1=暗号化, 2=復号化): ") if is_tty else input()
    except EOFError:
        sys.exit(2)  # 空文字扱い
    except Exception:
        sys.exit(1)

    mode = raw.strip()
    if not mode:
        sys.exit(2)


    if mode == "1":
    # テスト用のキー番号環境変数
        test_index = int(os.environ["TEST_KEY_INDEX"]) if "TEST_KEY_INDEX" in os.environ else None
        index, key = get_key(test_index)

    # 暗号化入力
        text = read_alpha_input("平文: ", is_tty) if is_tty else read_alpha_input(is_tty=is_tty)
        encrypted = vigenere_encrypt(text, key)

        print(index)
        print(encrypted)
        sys.exit(0)

    elif mode == "2":
    # 安全にキー番号を取得
        try:
            index = int(input("キー番号: " if is_tty else "").strip())
        except Exception:
            sys.exit(5)
        if not (0 <= index < len(keys)):
            sys.exit(5)

    # 復号入力
        text = read_alpha_input("暗号文: ", is_tty) if is_tty else read_alpha_input(is_tty=is_tty)
        key = keys[index]

        decrypted = vigenere_decrypt(text, key)
        print(decrypted)
        sys.exit(0)

    else:
        if is_tty:
            print("モードが正しくありません。1 または 2 を入力してください。")
        sys.exit(1)
